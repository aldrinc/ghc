Pre-Canon Market Research Workflow Refactor (Temporal, Python)

Summary
- Run a dedicated PreCanonMarketResearchWorkflow during onboarding to generate market research artifacts before canon creation.
- Use local prompt files (versioned in repo) with simple placeholder rendering; compute prompt SHA-256 for traceability.
- Activities own all I/O (LLM, storage, prompt loading); workflow code stays deterministic and passes only bounded summaries/refs.
- Outputs feed build_client_canon_activity via a compact canon_context bundle and persist alongside onboarding artifacts.

Goals
- Add child workflow for steps 1, 3, 4, 6, 7, 8, 9 of market research (step 2 is a stub).
- Produce one new artifact doc per step (Option A) and bounded summaries/handoffs; keep Temporal history well below limits.
- Extend canon/metrics onboarding flow to consume research context and persist artifact refs with prompt hashes.
- Keep prompt edits local (disk) with SHA-256 version traceability; avoid non-deterministic workflow code.

Non-Goals
- Implement ad scraping (step 2), video downloads, landing page crawling, swipe migration, or auto asset generation.
- Replace approval flows or downstream campaign/test workflows beyond wiring updates.

Prompt Files
- Location: ghc-platform/backend/app/prompts/precanon_research/
- Files: 01_competitor_research.md, 03_deep_research_prompt.md, 04_run_deep_research.md, 06_avatar_brief.md,
  07_offer_brief.md, 08_necessary_beliefs_prompt1.md, 09_i_believe_statements.md.
- Tokens: {{ORG_ID}}, {{CLIENT_ID}}, {{ONBOARDING_PAYLOAD_ID}}, {{BUSINESS_CONTEXT_JSON}}, {{STEP1_SUMMARY}},
  {{ADS_CONTEXT}}, {{STEP3_PROMPT}}, {{STEP4_SUMMARY}}, {{STEP6_SUMMARY}}, {{STEP7_SUMMARY}}, {{STEP8_SUMMARY}}.
- Each prompt must instruct output blocks: <SUMMARY>...</SUMMARY>, <CONTENT>...</CONTENT>; step 3 adds <STEP4_PROMPT>...</STEP4_PROMPT>.

Workflows
- New PreCanonMarketResearchWorkflow
  - Input dataclass PreCanonMarketResearchInput(org_id, client_id, onboarding_payload_id).
  - Runs activities sequentially: fetch_onboarding_payload_activity, get_ads_context_stub_activity (step 2),
    generate_research_step_artifact_activity for steps 1, 3, 4, 6, 7, 8, 9.
  - Builds artifacts list and canon_context bundle (bounded) for canon generation.
  - Output dataclasses: ResearchArtifactRef(step_key, doc_url, doc_id, summary, prompt_sha256, created_at_iso),
    PreCanonMarketResearchResult(artifacts: list[ResearchArtifactRef], canon_context: dict[str, Any]).
- ClientOnboardingWorkflow changes
  - Start child PreCanonMarketResearchWorkflow first.
  - Pass research.canon_context to build_client_canon_activity.
  - Persist research.artifacts with canon + metric schema.

Activities
- New module app.temporal.activities.precanon_research_activities:
  - fetch_onboarding_payload_activity(params) -> bounded dict.
  - get_ads_context_stub_activity(params) -> {"ads_context": "...stub..."}.
  - generate_research_step_artifact_activity(params) -> {doc_id, doc_url, summary, prompt_sha256, handoff?}.
    - Loads prompt file, renders placeholders, calls LLM, parses tagged blocks, writes new doc, returns refs only.
    - Include workflow_id + step_key in doc metadata/title for idempotent retries.
- Update app.temporal.activities.client_onboarding_activities:
  - build_client_canon_activity accepts precanon research/canon_context.
  - persist_client_onboarding_artifacts_activity stores research artifact refs (step_key, doc id/url, summary, prompt hash).

Determinism & Limits
- No file or network I/O inside workflows; all in activities.
- Keep payloads << Temporal 2MB limit; only summaries/refs in workflow state.
- Configure activity timeouts (start_to_close + schedule_to_close), longer for deep research (step 4).
- Compute prompt SHA-256 per file read and return with artifact refs for reproducibility.

Data/Storage
- Artifacts table stores new docs for each research step plus canon/metric schema.
- Persist prompt hashes, summaries, doc refs; do not store large content in workflow history.

Milestones
- M1: Wire PreCanonMarketResearchWorkflow steps 1/3/4, integrate as child workflow, persist artifacts (refs).
- M2: Add steps 6/7/8/9, assemble canon_context bundle.
- M3: Update canon builder to consume canon_context; persist research refs with onboarding artifacts.
- M4: Update TestCampaignWorkflow (or new test workflow) to reflect new gating sequence (research -> canon -> metric -> rest).

Acceptance
- Running ClientOnboardingWorkflow triggers precanon workflow before canon; approvals still gate canon/metric.
- Research outputs produce doc refs + bounded summaries; prompt hashes recorded.
- Prompt files live on disk and are read per activity invocation; edits reflected without redeploy beyond worker reload.
