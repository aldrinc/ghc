<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PDP UGC Q&amp;A</title>
    <link rel="stylesheet" href="./shared.css" />
    <link rel="stylesheet" href="./pdp_shared.css" />
    <style>
      #bubble-question {
        top: 56px;
        left: 30px;
        max-width: 72%;
      }

      #card.is-feed #bubble-question {
        top: 48px;
        left: 34px;
        max-width: 72%;
      }

      #bubble-answer {
        top: 182px;
        left: 14px;
        right: auto;
        max-width: 74%;
      }

      #card.is-feed #bubble-answer {
        top: 182px;
        left: 16px;
        right: auto;
        max-width: 74%;
      }

      #bubble-answer .pdp-bubble-copy {
        max-width: 280px;
      }

      #card.is-feed #bubble-answer .pdp-bubble-copy {
        max-width: 220px;
      }
    </style>
  </head>
  <body>
    <div id="card">
      <img id="bg" class="pdp-bg" alt="" />
      <div class="pdp-vignette"></div>

      <div id="bubble-question" class="pdp-bubble small pdp-comment-box">
        <div class="pdp-bubble-row">
          <img id="q-avatar" class="pdp-avatar" alt="" />
          <div class="pdp-bubble-copy">
            <div id="q-context" class="pdp-bubble-header"></div>
            <div id="q-text" class="pdp-bubble-text"></div>
          </div>
        </div>
      </div>

      <div id="bubble-answer" class="pdp-bubble small pdp-comment-box">
        <div class="pdp-bubble-row">
          <img id="a-avatar" class="pdp-avatar" alt="" />
          <div class="pdp-bubble-copy">
            <div class="pdp-bubble-header-line">
              <div id="a-context" class="pdp-bubble-header"></div>
            </div>
            <div id="a-text" class="pdp-bubble-text"></div>
          </div>
        </div>
      </div>

      <div class="pdp-strip">
        <div class="pdp-strip-left">
          <div class="pdp-rating-row">
            <div class="pdp-stars" aria-hidden="true">
              <svg class="pdp-star" viewBox="0 0 24 24"><path d="M12 2.4l2.6 5.4 6 .9-4.3 4.2 1 5.9L12 16.9l-5.3 2.9 1-5.9-4.3-4.2 6-.9L12 2.4z"/></svg>
              <svg class="pdp-star" viewBox="0 0 24 24"><path d="M12 2.4l2.6 5.4 6 .9-4.3 4.2 1 5.9L12 16.9l-5.3 2.9 1-5.9-4.3-4.2 6-.9L12 2.4z"/></svg>
              <svg class="pdp-star" viewBox="0 0 24 24"><path d="M12 2.4l2.6 5.4 6 .9-4.3 4.2 1 5.9L12 16.9l-5.3 2.9 1-5.9-4.3-4.2 6-.9L12 2.4z"/></svg>
              <svg class="pdp-star" viewBox="0 0 24 24"><path d="M12 2.4l2.6 5.4 6 .9-4.3 4.2 1 5.9L12 16.9l-5.3 2.9 1-5.9-4.3-4.2 6-.9L12 2.4z"/></svg>
              <svg class="pdp-star" viewBox="0 0 24 24"><path d="M12 2.4l2.6 5.4 6 .9-4.3 4.2 1 5.9L12 16.9l-5.3 2.9 1-5.9-4.3-4.2 6-.9L12 2.4z"/></svg>
            </div>
            <div class="pdp-rating-text">
              <span id="rating-value"></span>
              <span id="rating-detail"></span>
            </div>
          </div>
          <div id="cta" class="pdp-cta"></div>
        </div>

        <div class="pdp-logo">
          <img id="logo-img" alt="" />
          <div id="logo-text" class="pdp-logo-text"></div>
        </div>
      </div>
    </div>

    <script>
      const waitForImage = (img) =>
        new Promise((resolve, reject) => {
          if (!img) {
            reject(new Error('Image element not found.'));
            return;
          }
          if (img.complete && img.naturalWidth > 0) {
            resolve();
            return;
          }
          img.addEventListener('load', () => resolve(), { once: true });
          img.addEventListener('error', () => reject(new Error('Failed to load image.')), { once: true });
        });

      const setOutputPreset = (output) => {
        const preset = output && output.preset;
        if (preset === 'feed') {
          document.getElementById('card').classList.add('is-feed');
          return;
        }
        if (preset === 'tiktok') {
          return;
        }
        throw new Error(`Unsupported output.preset: ${preset}`);
      };

      const setLogo = (brand, waits) => {
        const img = document.getElementById('logo-img');
        const text = document.getElementById('logo-text');
        img.style.display = 'none';
        text.style.display = 'none';

        if (brand.logoUrl) {
          img.src = brand.logoUrl;
          img.alt = 'Brand logo';
          img.style.display = 'block';
          waits.push(waitForImage(img));
          return;
        }

        text.textContent = brand.logoText;
        text.style.display = 'block';
      };

      const setContextLine = (el, handle, verified = false) => {
        el.innerHTML = '';
        const prefix = document.createElement('span');
        prefix.textContent = 'Reply to ';
        const handleSpan = document.createElement('span');
        handleSpan.className = 'pdp-handle';
        handleSpan.textContent = `${handle}'s`;
        const verifiedBadge = document.createElement('span');
        verifiedBadge.className = 'pdp-verified';
        verifiedBadge.title = 'Verified';
        verifiedBadge.setAttribute('aria-label', 'Verified');
        verifiedBadge.innerHTML =
          '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M9.3 12.8 7.1 10.6 6 11.7l3.3 3.3L18 6.3l-1.1-1.1z"></path></svg>';
        const suffix = document.createElement('span');
        suffix.textContent = ' comment';
        el.appendChild(prefix);
        el.appendChild(handleSpan);
        if (verified) {
          el.appendChild(verifiedBadge);
        }
        el.appendChild(suffix);
      };

      window.setCardData = async (data) => {
        if (!data || typeof data !== 'object') {
          throw new Error('Payload must be an object.');
        }

        setOutputPreset(data.output);

        const card = document.getElementById('card');
        card.style.setProperty('--strip-bg', data.brand.stripBgColor);
        card.style.setProperty('--strip-text', data.brand.stripTextColor);

        const waits = [];

        const bg = document.getElementById('bg');
        bg.src = data.background.imageUrl;
        bg.alt = data.background.alt || '';
        waits.push(waitForImage(bg));

        const qAvatar = document.getElementById('q-avatar');
        if (data.question.avatarUrl) {
          qAvatar.src = data.question.avatarUrl;
          qAvatar.alt = '';
          waits.push(waitForImage(qAvatar));
        } else {
          qAvatar.style.display = 'none';
        }

        const aAvatar = document.getElementById('a-avatar');
        if (data.answer.avatarUrl) {
          aAvatar.src = data.answer.avatarUrl;
          aAvatar.alt = '';
          waits.push(waitForImage(aAvatar));
        } else {
          aAvatar.style.display = 'none';
        }

        setContextLine(document.getElementById('q-context'), data.question.handle, false);
        document.getElementById('q-text').textContent = data.question.text;

        setContextLine(document.getElementById('a-context'), data.answer.handle, data.answer.verified === true);
        document.getElementById('a-text').textContent = data.answer.text;

        document.getElementById('rating-value').textContent = data.rating.valueText;
        document.getElementById('rating-detail').textContent = ` ${data.rating.detailText}`;
        document.getElementById('cta').textContent = data.cta.text;

        setLogo(data.brand, waits);

        await Promise.all(waits);
      };
    </script>
  </body>
</html>
