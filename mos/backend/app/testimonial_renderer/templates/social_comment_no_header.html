<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FB-Style Comment Section (No Header)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              fb: [
                '-apple-system',
                'BlinkMacSystemFont',
                '"Segoe UI"',
                'Roboto',
                '"Helvetica Neue"',
                'Arial',
                'sans-serif',
              ],
            },
            colors: {
              fbBlue: '#1877F2',
              fbText: '#050505',
              fbMuted: '#65676B',
              fbLine: '#E4E6EB',
              fbBg: '#F0F2F5',
            },
          },
        },
      };
    </script>
  </head>

  <body class="bg-fbBg font-fb text-fbText antialiased">
    <div id="card" class="mx-auto w-full max-w-[430px] bg-white">
      <div id="comment-section" class="pb-6"></div>
    </div>

    <script>
      const waitForImage = (img) =>
        new Promise((resolve, reject) => {
          if (!img) {
            reject(new Error('Image element not found.'));
            return;
          }
          if (img.complete && img.naturalWidth > 0) {
            resolve();
            return;
          }
          img.addEventListener('load', () => resolve(), { once: true });
          img.addEventListener('error', () => reject(new Error('Failed to load image.')), { once: true });
        });

      const initials = (value) => {
        const text = (value || '?').trim();
        return text ? text.slice(0, 1).toUpperCase() : '?';
      };

      const createIconButton = (svg, label) => {
        const button = document.createElement('button');
        button.className = '-m-2 p-2 active:opacity-60';
        button.type = 'button';
        button.setAttribute('aria-label', label);
        button.innerHTML = svg;
        return button;
      };

      const buildReactionCount = (count) => {
        const container = document.createElement('div');
        container.className = 'flex items-center gap-1';
        container.innerHTML =
          '<span class="inline-flex h-[18px] w-[18px] items-center justify-center rounded-full bg-fbBlue">' +
          '<svg viewBox="0 0 24 24" class="h-[12px] w-[12px] text-white" fill="currentColor">' +
          '<path d="M7.8 10.7v9.3c0 .6-.5 1-1 1H5.2c-.6 0-1-.4-1-1v-7.3c0-.5.4-1 1-1h2.6Zm2.1-.1 4.6-6.2c.5-.7 1.6-.3 1.5.6l-.4 4.4h5c.9 0 1.5.8 1.3 1.7l-1.4 6.6c-.2.8-.9 1.4-1.8 1.4H11.4c-.8 0-1.5-.7-1.5-1.5v-6.6Z"/>' +
          '</svg>' +
          '</span>';
        const value = document.createElement('span');
        value.textContent = String(count);
        container.appendChild(value);
        return container;
      };

      const buildAvatar = (comment, sizeClass, imageList) => {
        const wrapper = document.createElement('div');
        wrapper.className = `mt-[2px] ${sizeClass} shrink-0 overflow-hidden rounded-full bg-[#DADDE1] flex items-center justify-center font-semibold text-neutral-700`;
        if (comment.avatarUrl) {
          const img = document.createElement('img');
          img.className = 'h-full w-full object-cover';
          img.alt = 'Avatar';
          img.src = comment.avatarUrl;
          wrapper.appendChild(img);
          imageList.push(img);
        } else {
          const label = document.createElement('span');
          label.textContent = initials(comment.name);
          label.className = 'text-sm';
          wrapper.appendChild(label);
        }
        return wrapper;
      };

      const buildCommentRow = (comment, options) => {
        const { imageList, isReply, isFirst } = options;
        const container = document.createElement('div');
        container.className = `flex gap-3 px-4 ${isFirst ? 'pt-4' : 'pt-5'}`;

        const avatarSize = isReply ? 'h-9 w-9' : 'h-10 w-10';
        const avatar = buildAvatar(comment, avatarSize, imageList);

        const body = document.createElement('div');
        body.className = 'min-w-0 flex-1';

        const headerRow = document.createElement('div');
        headerRow.className = 'flex items-baseline gap-2';

        const name = document.createElement('div');
        name.className = 'truncate text-[15px] font-semibold';
        name.textContent = comment.name;

        const meta = document.createElement('div');
        meta.className = 'flex items-center gap-1 text-[13px] text-fbMuted';
        meta.innerHTML = '<span>&middot;</span>';
        const time = document.createElement('span');
        time.textContent = comment.meta.time;
        meta.appendChild(time);

        const followLabel = comment.meta.followLabel;
        if (followLabel) {
          const dot = document.createElement('span');
          dot.textContent = '.';
          meta.appendChild(dot);
        }

        headerRow.appendChild(name);
        headerRow.appendChild(meta);

        if (followLabel) {
          const follow = document.createElement('a');
          follow.className = 'text-[13px] font-semibold text-fbBlue';
          follow.href = '#';
          follow.textContent = followLabel;
          headerRow.appendChild(follow);
        }

        const text = document.createElement('div');
        text.className = 'text-[15px] leading-[18px]';
        text.textContent = comment.text;

        body.appendChild(headerRow);
        body.appendChild(text);

        if (comment.attachmentUrl) {
          const attachment = document.createElement('div');
          attachment.className = 'mt-2 w-[220px] overflow-hidden rounded-2xl';
          const img = document.createElement('img');
          img.className = 'h-auto w-full object-cover';
          img.alt = 'Attachment';
          img.src = comment.attachmentUrl;
          attachment.appendChild(img);
          body.appendChild(attachment);
          imageList.push(img);
        }

        const actionsRow = document.createElement('div');
        actionsRow.className = 'mt-1 flex items-center justify-between';

        const leftActions = document.createElement('div');
        leftActions.className = 'flex items-center gap-4 text-[13px] font-semibold text-fbMuted';

        const replyBtn = document.createElement('button');
        replyBtn.className = 'active:opacity-60';
        replyBtn.type = 'button';
        replyBtn.textContent = 'Reply';
        leftActions.appendChild(replyBtn);

        if (typeof comment.reactionCount === 'number' && comment.reactionCount > 0) {
          leftActions.appendChild(buildReactionCount(comment.reactionCount));
        }

        const rightActions = document.createElement('div');
        rightActions.className = 'flex items-center gap-5 text-fbMuted';

        const likeIcon =
          '<svg viewBox="0 0 24 24" class="h-[20px] w-[20px]" fill="none" stroke="currentColor" stroke-width="1.6">' +
          '<path stroke-linecap="round" stroke-linejoin="round" d="M7.5 10.6v9.6H5.2a1.4 1.4 0 0 1-1.4-1.4v-7a1.4 1.4 0 0 1 1.4-1.4h2.3Zm0 0 5-6.6c.7-1 2.3-.4 2.2.9l-.4 4.4h5.1c1.2 0 2 .9 1.8 2l-1.4 6.5c-.2 1-1 1.7-2 1.7H9.2a1.7 1.7 0 0 1-1.7-1.7v-7.2Z" />' +
          '</svg>';
        const replyIcon =
          '<svg viewBox="0 0 24 24" class="h-[20px] w-[20px]" fill="none" stroke="currentColor" stroke-width="1.6">' +
          '<path stroke-linecap="round" stroke-linejoin="round" d="M20 14.5c0 1.7-1.6 3-3.5 3H9l-4.2 2.3c-.4.2-.8-.2-.7-.6l.7-2.9C3.6 15.7 3 15.2 3 14.5V7.8C3 6 4.6 4.5 6.5 4.5h10C18.4 4.5 20 6 20 7.8v6.7Z" />' +
          '</svg>';

        rightActions.appendChild(createIconButton(likeIcon, 'Like'));
        rightActions.appendChild(createIconButton(replyIcon, 'Reply'));

        actionsRow.appendChild(leftActions);
        actionsRow.appendChild(rightActions);
        body.appendChild(actionsRow);

        if (comment.viewRepliesText) {
          const viewReplies = document.createElement('button');
          viewReplies.className = 'mt-2 text-[13px] font-semibold text-fbMuted active:opacity-60';
          viewReplies.type = 'button';
          viewReplies.textContent = comment.viewRepliesText;
          body.appendChild(viewReplies);
        }

        container.appendChild(avatar);
        container.appendChild(body);
        return container;
      };

      const buildReplies = (replies, options) => {
        const { viewRepliesText, imageList } = options;
        const wrapper = document.createElement('div');
        wrapper.className = 'relative mt-2 pl-4';

        const line = document.createElement('div');
        line.className = 'absolute left-[34px] top-0 h-full w-[2px] bg-fbLine';
        const curve = document.createElement('div');
        curve.className = 'absolute left-[34px] top-[6px] h-4 w-4 rounded-bl-[10px] border-b-[2px] border-l-[2px] border-fbLine';

        const inner = document.createElement('div');
        inner.className = 'ml-9';

        replies.forEach((reply, index) => {
          inner.appendChild(buildCommentRow(reply, { imageList, isReply: true, isFirst: index === 0 }));
        });

        if (viewRepliesText) {
          const viewReplies = document.createElement('button');
          viewReplies.className = 'mt-2 text-[13px] font-semibold text-fbMuted active:opacity-60';
          viewReplies.type = 'button';
          viewReplies.textContent = viewRepliesText;
          inner.appendChild(viewReplies);
        }

        wrapper.appendChild(line);
        wrapper.appendChild(curve);
        wrapper.appendChild(inner);
        return wrapper;
      };

      window.setCardData = async (data) => {
        if (!data || typeof data !== 'object') {
          throw new Error('Payload must be an object.');
        }
        const section = document.getElementById('comment-section');
        section.innerHTML = '';

        if (!Array.isArray(data.comments) || data.comments.length === 0) {
          throw new Error('comments must be a non-empty array.');
        }

        const fragment = document.createDocumentFragment();
        const imageList = [];

        data.comments.forEach((comment, index) => {
          fragment.appendChild(buildCommentRow(comment, { imageList, isReply: false, isFirst: index === 0 }));
          if (Array.isArray(comment.replies) && comment.replies.length > 0) {
            fragment.appendChild(buildReplies(comment.replies, { imageList, viewRepliesText: comment.viewRepliesText }));
          }
        });

        section.appendChild(fragment);
        await Promise.all(imageList.map(waitForImage));
      };
    </script>
  </body>
</html>
